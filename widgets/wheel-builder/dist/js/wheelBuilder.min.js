!function(){function e(e,l,r){var s=this;if(e&&"string"==typeof e)if(l&&"object"!=typeof l)console.error("Invalid layer stacks");else if(LayerBuilder&&"function"==typeof LayerBuilder){if("object"!=typeof r&&(r={}),r.hasOwnProperty("defaultLayerOpts")&&r.defaultLayerOpts.length?this.defaultLayerOpts=r.defaultLayerOpts:this.defaultLayerOpts=null,this.dev=!!r.hasOwnProperty("dev")&&!!r.dev,this.containerId=e,this.container=document.getElementById(e),this.smallWidth=900,this.smallestWidth=500,this.dirtyStacks=l,this.layerStacks=[],this.stackLookup={},this.visibleStacks=0,this.initPromise=new t,this.asyncPromise=new t,this.loadedPromise=new t,this.tplLoaded=!1,this.cssLoaded=!1,this.extJsLoaded=!1,this.cdnUrl="https://rawgit.com/Burkson/com.burkson.ridestyler.widgets/master/widgets/wheel-builder/dist/",this.urlPfx=this.dev?"src/":this.cdnUrl,this.tplUrl=this.urlPfx+"html/template.html",r.hasOwnProperty("cssUrl")?this.cssUrl=!(!r.cssUrl||"string"!=typeof r.cssUrl)&&r.cssUrl:this.cssUrl=this.dev?this.urlPfx+"css/wheelBuilder.css":this.urlPfx+"css/wheelBuilder.min.css",window.jscolor||(this.jsColorUrl=this.urlPfx+"js/jscolor.min.js"),this.tplHtml="",this.wrapEl=null,this.ctrlWrap=null,this.selectorEl=null,this.layerSelectWrap=null,this.layerOptsWrap=null,this.topBar=null,this.ctrlHeader=null,this.ctrlTitle=null,this.ctrl=null,this.backBtn=null,this.selectedStack=null,this.dfltColorOp="multiply",this.dfltPickerColor="FFFFFF",this.dfltCtrlTitle="Customize",this.dfltWheelDims=[500,500],r.hasOwnProperty("wheelDims")&&"object"==typeof r.wheelDims&&2===r.wheelDims.length){var n=parseInt(r.wheelDims[0]),a=parseInt(r.wheelDims[1]);isNaN(n)||isNaN(a)?this.wheelDims=this.dfltWheelDims:this.wheelDims=[n,a]}else this.wheelDims=this.dfltWheelDims;this.cancelText=r.cancelText?r.cancelText:"Cancel",this.confirmText=r.confirmText?r.confirmText:"Confirm",this.onCancel="function"==typeof r.onCancel?r.onCancel:null,this.onConfirm="function"==typeof r.onConfirm?r.onConfirm:null,this.container?(s.initPromise.resolve(),s.onDomReady()):document.addEventListener("DOMContentLoaded",function(){s.container=document.getElementById(s.containerId),s.container?(s.initPromise.resolve(),s.onDomReady()):console.error("Container does not exist")})}else console.error("LayerBuilder not found");else console.error("Invalid container ID")}function t(){function e(e){n.push(e),t()}function t(){if(r!==l.pending)for(;n.length>0;){var e=n.shift();r===l.resolved&&"function"==typeof e.done?e.done(s):r===l.rejected&&"function"==typeof e.fail&&e.fail(s),"function"==typeof e.always&&e.always(s)}}var l={pending:0,resolved:1,rejected:2},r=l.pending,s=null,n=[];return{state:function(){return r},value:function(){return s},changeState:function(e,n){return r===e?console.error("Cannot changeState to same state: "+e):r!==l.pending?console.error("Cannot changeState when promise is finalized."):(r=e,s=n,t(),r)},resolve:function(e){this.changeState(l.resolved,e)},reject:function(e){this.changeState(l.rejected,e)},always:function(t){return e({always:t}),this},done:function(t){return e({done:t}),this},fail:function(t){return e({fail:t}),this},isResolved:function(){return r===l.resolved},isRejected:function(){return r===l.rejected}}}e.prototype.checkLoaded=function(){for(var e=this.layerStacks.length,t=0,l=0;l<e;l++)this.layerStacks[l].lb.loaded&&t++;t===e&&this.loadedPromise.resolve()},e.prototype.loaded=function(e){this.loadedPromise.done(function(){e.call()})},e.prototype.onDomReady=function(){var e=this.onAsyncComplete;null!=this.container?(this.loadExternalJs(e),this.loadStyles(e),this.loadTemplate(e)):console.error("Invalid container Id")},e.prototype.isAsyncComplete=function(){return this.tplLoaded&&this.cssLoaded&&this.extJsLoaded},e.prototype.onAsyncComplete=function(){this.isAsyncComplete()&&(this.initApp(),this.asyncPromise.resolve())},e.prototype.initApp=function(){var e=this,t=this.dirtyStacks.length;if(this.isAsyncComplete()){this.container.innerHTML=this.tplHtml,this.wrapEl=document.getElementById("wb-wrapper"),this.ctrlWrap=this.wrapEl.getElementsByClassName("wb-ctrl-wrap")[0],this.layerSelectWrap=this.ctrlWrap.getElementsByClassName("wb-layer-select")[0],this.layerOptsWrap=this.ctrlWrap.getElementsByClassName("wb-layer-options")[0],this.selectorEl=this.wrapEl.getElementsByClassName("wb-wheel-selector")[0],this.topBar=this.wrapEl.getElementsByClassName("wb-top-bar")[0],this.logo=this.topBar.getElementsByClassName("wb-logo")[0],this.ctrlHeader=this.ctrlWrap.getElementsByClassName("wb-ctrl-header")[0],this.ctrlTitle=this.ctrlWrap.getElementsByClassName("wb-ctrl-title")[0],this.ctrl=this.ctrlWrap.getElementsByClassName("wb-ctrl")[0],this.backBtn=this.ctrlHeader.getElementsByClassName("wb-back-btn")[0],this.initTop(),window.addEventListener("resize",function(){e.adjustLayout()});for(var l=0;l<t;l++)this.addLayerStack(this.dirtyStacks[l]);this.loadedPromise.done(function(){e.renderCtrl(),e.renderStackSelector(),e.renderPreview()}),this.adjustLayout()}else console.error("Template not loaded, unable to initialize app")},e.prototype.initTop=function(){var e=this,t=this.topBar.getElementsByClassName("wb-top-button-left")[0],l=this.topBar.getElementsByClassName("wb-top-button-right")[0];this.onCancel?(t.innerText=this.cancelText,t.onclick=function(){e.onCancel.call()}):o(t),this.onConfirm?(l.innerText=this.confirmText,l.onclick=function(){e.onConfirm.call()}):o(l),download=this.wrapEl.getElementsByClassName("wb-download")[0],download.onclick=function(t){e.onDownloadClick(t)},this.backBtn.onclick=function(){e.onBackClick()},i(this.topBar,"table",!0)},e.prototype.adjustLayout=function(){if(this.container){var e=this.container.offsetWidth;this.wrapEl&&(e<=this.smallestWidth?(s(this.wrapEl,"wb-small")||n(this.wrapEl,"wb-small"),s(this.wrapEl,"wb-smallest")||n(this.wrapEl,"wb-smallest")):e<=this.smallWidth?(s(this.wrapEl,"wb-small")||n(this.wrapEl,"wb-small"),a(this.wrapEl,"wb-smallest")):a(this.wrapEl,["wb-small","wb-smallest"]))}},e.prototype.selectStack=function(e){this.layerStacks[this.selectedStack];var t=this.getLayerStack(e);t.layerSelectEl||this.createLayerSelector(t,!0),this.togglePreviewStack(t),this.selectedStack=this.stackLookup[e]},e.prototype.createLayerSelector=function(e){var t=this,s=e.layers.length,a="",o=null,i=null,c=null,d=null,h=null,p=document.createElement("ul");n(p,"wb-layer-selector");for(var y=0;y<s;y++)(o=e.layers[y]).readOnly||(a=l(o.name),d=document.createElement("a"),h=document.createElement("li"),i=document.createElement("span"),c=document.createElement("span"),n(h,"wb-ctrl-layer"),n(h,"wb-ctrl-layer-"+a),n(i,"wb-color"),o.currentColor&&(i.style.backgroundColor=o.currentColor),c.innerText=o.name+" +",d.appendChild(i),d.appendChild(c),d.setAttribute("data-layeridx",y),d.onclick=function(l){var s=l.target,n=null;"A"!==s.tagName&&(s=s.parentElement),n=parseInt(s.getAttribute("data-layeridx")),t.showLayerOpts(e,n),r(t.layerOptsWrap,t.layerSelectWrap)},h.appendChild(d),p.appendChild(h));h=document.createElement("li"),e.layerSelectEl=p,this.layerSelectWrap.appendChild(p)},e.prototype.showLayerOpts=function(e,t){var s=this,a=e.layers[t],o=(l(a.name),a.options),c=null,d=null,h=null,p=null,y=null,m=null,u=null,f=null,w=null,g=null,b="";if("object"==typeof o&&o.length){this.setCtrlTitle("Options"),this.layerOptsWrap.innerHTML="",c=document.createElement("ul"),p=document.createElement("li"),d=document.createElement("button"),p.innerText=a.name+" -",i(p),c.appendChild(p);for(var C=0,k=o.length;C<k;C++)"string"==typeof o[C].name&&o[C].name.trim()?"string"==typeof o[C].color&&o[C].color.trim()?(b="string"!=typeof o[C].operation||-1===e.lb.getOperations().indexOf(o[C].operation.toLowerCase())?this.dfltColorOp:o[C].operation.trim().toLowerCase(),y=document.createElement("li"),u=document.createElement("span"),m=document.createElement("a"),n(u,"wb-color"),u.style.backgroundColor=o[C].color.trim(),m.appendChild(u),m.onclick=function(e){var t=e.target,l="",r="";"A"!==t.tagName&&(t=t.parentElement),l=t.getAttribute("data-color"),r=t.getAttribute("data-operation"),w.fromString(l),s.setLayerColor(a.name,l,r)},m.setAttribute("data-color",o[C].color.trim()),m.setAttribute("data-operation",b),m.setAttribute("title",o[C].name),y.appendChild(m),c.appendChild(y)):console.error("Invalid color provided for layer "+a.name+" option "+o.name):console.error("Invalid name provided for layer "+a.name+" option");this.layerOptsWrap.appendChild(c),f=document.createElement("input"),n(f,"jscolor"),u=document.createElement("span"),n(u,"wb-color"),y=document.createElement("li"),n(y,"wb-custom-color"),g=document.createElement("a"),n(g,"wb-js-color"),g.innerHTML="<span> Custom Color</span>",g.setAttribute("title","Custom Color"),g.onclick=function(){w.show()},(w=new jscolor(f,{hash:!0,closable:!0})).fromString(a.currentColor?a.currentColor:this.dfltPickerColor),w.onFineChange=function(){var e=this.toHEXString();s.setLayerColor(a.name,e),u.style.backgroundColor=e},g.appendChild(f),g.insertBefore(u,g.firstElementChild),y.appendChild(g),c.appendChild(y),h=document.createElement("div"),n(h,"wb-button-wrap"),d.innerText="Reset",d.onclick=function(){w.fromString(s.dfltPickerColor),u.style.backgroundColor="#"+s.dfltPickerColor,s.resetLayer(a.name)},h.appendChild(d),this.layerOptsWrap.appendChild(h),i(this.backBtn,"inline"),r(this.layerOptsWrap,this.layerSelectWrap)}},e.prototype.addLayerStack=function(e){var t=this;e&&"object"==typeof e?this.asyncPromise.done(function(){var r=t.getLayerStack(e.name),s=t.wrapEl.getElementsByClassName("wb-wheel-preview-inner")[0],a=null,i=null,c="";if(e.name&&e.name.trim())if(e.name=e.name.trim(),c=l(e.name.toLowerCase()),e.visible=!!e.visible,e.selected=!!e.selected,"object"==typeof e.layers&&e.layers.length){for(var d=0,h=e.layers.length;d<h;d++)e.layers[d]=t.validateLayer(e.layers[d]),e.layers[d]||e.layers.splice(d,1);r?((a=t.wrapEl.getElementById("wb-wheel-"+c)).innerHTML="",idx=t.stackLookup[e.name],t.layerStacks[idx]=e):((a=document.createElement("div")).id="wb-wheel-"+c,s.appendChild(a),idx=t.layerStacks.length,t.stackLookup[e.name]=idx,t.layerStacks[idx]=e),n(a,"wb-wheel"),(i=new LayerBuilder(a.id,{dimensions:t.wheelDims})).setLayers(e.layers).done(function(){dims=i.getDimensions(),a.style.width=dims.width+"px",a.style.height=dims.height+"px",e.visible&&t.addStackSelector(e),e.selected||o(a)}),i.imgLoadPromise.done(function(){t.checkLoaded()}),t.layerStacks[idx].lb=i,t.layerStacks[idx].containEl=a,t.layerStacks[idx].idx=idx,e.visible&&(t.visibleStacks++,e.selected&&(n(a,"wb-wheel-selected"),t.selectedStack=idx,t.selectStack(e.name)))}else console.error("No layers provided");else console.error("No name provided for layer stack")}):console.error("Invalid layer stack")},e.prototype.addStackSelector=function(e){var t=this,l=e.lb.getImage(),r=new Image,s=document.createElement("li"),o=null;r.src=l,s.appendChild(r),s.onclick=function(l){var r=l.target,s=r,o=t.selectorEl.getElementsByClassName("wb-stack-selected")[0];"li"!==r.tagName.toLowerCase()&&(s=r.parentElement),a(o,"wb-stack-selected"),t.selectStack(e.name),n(s,"wb-stack-selected")},e.selected&&n(s,"wb-stack-selected"),this.selectorEl.children.length?(o=this.selectorEl.children[e.idx])?this.selectorEl.insertBefore(s,o):e.idx>=this.selectorEl.children.length?this.selectorEl.appendChild(s):this.selectorEl.insertBefore(s,this.selectorEl.firstChild):this.selectorEl.appendChild(s)},e.prototype.setLayerColor=function(e,t,r){var s=this.layerStacks.length,n=null,a=null,o=null,i=l(e),c=this.layerSelectWrap.getElementsByClassName("wb-ctrl-layer-"+i);if("string"==typeof e&&e.trim()){for(var d=0;d<s;d++)if(a=this.layerStacks[d],(o=a.lb.getLayer(e))&&!o.readOnly){a.lb.setColor(e,t,r),n=a.layers.length;for(var h=0;h<n;h++)a.layers[h].name===e&&(a.layers[h].currentColor=t)}for(s=c.length,d=0;d<s;d++)c[d].getElementsByTagName("span")[0].style.backgroundColor=t}else console.error("Invalid layer name")},e.prototype.togglePreviewStack=function(e){var t=this,l=this.layerStacks[this.selectedStack],s=null;l&&l!==e&&((s=l.containEl).style.opacity=0,a(s,"wb-wheel-selected"),l.layerSelectEl.style.opacity=0),setTimeout(function(){s&&(o(s),o(l.layerSelectEl)),n(e.containEl,"wb-wheel-selected"),e.containEl.style.display="block",e.containEl.clientWidth,e.containEl.style.opacity=1,e.layerSelectEl.style.display="block",e.layerSelectEl.clientWidth,e.layerSelectEl.style.opacity=1,r(t.layerSelectWrap,t.layerOptsWrap),t.setStackTitle(e.name)},250)},e.prototype.renderCtrl=function(){i(this.ctrlWrap,"table-cell",!0),this.setCtrlTitle();var e=parseInt(this.wheelDims[1]-this.ctrlHeader.clientHeight);!isNaN(e)&&e>0&&(this.ctrl.style.height=e+"px")},e.prototype.renderStackSelector=function(){this.visibleStacks>1?i(this.selectorEl,"table-cell",!0):o(this.selectorEl,!0)},e.prototype.renderPreview=function(){if(this.wheelDims&&this.wheelDims.length){var e=this.wrapEl.getElementsByClassName("wb-wheel-preview-inner")[0];e.style.width=this.wheelDims[0]+"px",e.style.height=this.wheelDims[1]+"px"}},e.prototype.setCtrlTitle=function(e){this.ctrlTitle.innerText=e||this.dfltCtrlTitle},e.prototype.onBackClick=function(){this.setCtrlTitle(),o(this.backBtn),r(this.layerSelectWrap,this.layerOptsWrap)},e.prototype.resetLayer=function(e){for(var t=this.layerStacks.length,r=null,s=null,n=l(e),a=this.layerSelectWrap.getElementsByClassName("wb-ctrl-layer-"+n),o=0;o<t;o++){(s=this.layerStacks[o]).lb.resetLayer(e),r=s.layers.length;for(var i=0;i<r;i++)s.layers[i].name===e&&(s.layers[i].currentColor="")}for(t=a.length,o=0;o<t;o++)a[o].getElementsByTagName("span")[0].style.backgroundColor=""},e.prototype.resetAllLayers=function(){for(var e=this.layerStacks.length,t=null,l=null,r=this.ctrlWrap.getElementsByClassName("wb-color"),s=0;s<e;s++){(l=this.layerStacks[s]).lb.resetAllLayers(),t=l.layers.length;for(var n=0;n<t;n++)l.layers[n].currentColor=""}for(e=r.length,s=0;s<e;s++)r[s].style.backgroundColor=""},e.prototype.validateLayer=function(e){return"object"!=typeof e?(console.error("Invalid layer for stack "+ls.name),!1):"string"!=typeof e.name||"string"!=typeof e.img?(console.error("Layer name and img properties invalid"),!1):(e.name=e.name.trim(),e.img=e.img.trim(),e.label="string"==typeof e.label&&e.label.trim()?e.label:e.name,e.readOnly=!!e.readOnly,e.options&&"object"==typeof e.options&&e.options.length||(self.defaultLayerOpts.length?e.options=self.defaultLayerOpts:(e.readOnly=!0,e.options=[])),e)},e.prototype.getLayerStack=function(e){return this.stackLookup.hasOwnProperty(e)?this.layerStacks[this.stackLookup[e]]:null},e.prototype.setStackTitle=function(e){"string"==typeof e&&(this.logo.innerText=e)},e.prototype.loadExternalJs=function(e){if(this.jsColorUrl){var t=this,l=document.createElement("script"),r=document.getElementsByTagName("head")[0];l.type="text/javascript",l.src=this.jsColorUrl,l.onload=function(){t.extJsLoaded||(t.extJsLoaded=!0,"function"==typeof e&&e.apply(t))},r.insertBefore(l,r.firstElementChild)}else this.extJsLoaded=!0},e.prototype.loadTemplate=function(e){var t=this,l=new XMLHttpRequest;l.onreadystatechange=function(){4===l.readyState&&(200===l.status?(t.tplHtml=l.responseText,t.tplLoaded=!0,"function"==typeof e&&e.apply(t)):console.error("xhr request for template failed"))},l.open("GET",this.tplUrl,!0),l.send(null)},e.prototype.loadStyles=function(e){if(this.cssUrl){var t=this,l=document.createElement("link"),r=document.getElementsByTagName("head")[0];l.rel="stylesheet",l.type="text/css",l.href=this.cssUrl,l.onload=function(){t.cssLoaded||(t.cssLoaded=!0,"function"==typeof e&&e.apply(t))},r.insertBefore(l,r.firstElementChild)}else this.cssLoaded=!0},e.prototype.getStackImage=function(e){var t=this.getLayerStack(e),l=null;return t&&t.lb&&(l=t.lb.getUnscaledImage()),l},e.prototype.onDownloadClick=function(e){var t=e.target,r=this.layerStacks[this.selectedStack],s=l(r.name)+".png",n="";r&&r.lb?(n=this.getStackImage(r.name),window.navigator.msSaveBlob?window.navigator.msSaveBlob(n,s):(t.href=n,t.download=s)):console.error("Cannot export: no stack selected")};var l=function(e){return e.replace(/\W+/g,"-")},r=function(e,t){t&&(t.style.display="none",t.style.opacity=0),e&&(e.style.display="block",e.clientWidth,e.style.opacity=1)},s=function(e,t){var l=new RegExp("(?:\\s|^)"+t+"(?:\\s|$)");return!!e.className.match(l)},n=function(e,t){-1===e.className.indexOf(t)&&(e.className+=" "+t,e.className=e.className.trim())},a=function(e,t){var l=null,r=0;"object"!=typeof t&&(t=[t]),r=t.length;for(var s=0;s<r;s++)l=new RegExp("(?:\\s|^)"+t[s]+"(?:\\s|$)"),e.className=e.className.replace(l," ")},o=function(e,t){e&&"object"==typeof e&&(t&&(e.style.opacity=0),e.style.display="none")},i=function(e,t,l){e&&"object"==typeof e&&(e.style.display=t||"block",l&&(e.style.opacity=1))};window.WheelBuilder=e}();