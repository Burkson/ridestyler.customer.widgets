!function(){function e(e,t){var i=this;if(e&&"string"==typeof e){if("object"!=typeof t&&(t={}),this.containerId=e,this.container=document.getElementById(e),this.name="string"==typeof t.name?t.name.trim():"",this.dimensions=null,t.hasOwnProperty("dimensions")&&"object"==typeof t.dimensions&&2===t.dimensions.length){var a=parseInt(t.dimensions[0]),n=parseInt(t.dimensions[1]);isNaN(a)||isNaN(n)||(this.dimensions=[a,n])}this.layers=[],this.layerHash={},this.layerCount=0,this.loaded=!1,this.imgLoadPromise=new r,this.initPromise=new r,this.imgOperations=["multiply","screen","grayscale"],this.dfltOperation="multiply",this.dfltCanvasStyle={position:"absolute",opacity:0},this.container?i.initPromise.resolve():document.addEventListener("DOMContentLoaded",function(){i.container=document.getElementById(i.containerId),i.initPromise.resolve()})}else console.error("Invalid containerId")}function t(e){var t=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,i=null;return e=e.replace(t,function(e,t,i,a){return t+t+i+i+a+a}),(i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e))?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null}function i(e,t,i){e/=255,t/=255,i/=255;var a,n,r=Math.max(e,t,i),o=Math.min(e,t,i),s=(r+o)/2;if(r==o)a=n=0;else{var l=r-o;switch(n=s>.5?l/(2-r-o):l/(r+o),r){case e:a=(t-i)/l+(t<i?6:0);break;case t:a=(i-e)/l+2;break;case i:a=(e-t)/l+4}a/=6}return{h:a,s:n,l:s}}function a(e,t,i){var a,r,o;if(0==t)a=r=o=i;else{var s=i<.5?i*(1+t):i+t-i*t,l=2*i-s;a=n(l,s,e+1/3),r=n(l,s,e),o=n(l,s,e-1/3)}return{r:Math.round(255*a),g:Math.round(255*r),b:Math.round(255*o)}}function n(e,t,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+(t-e)*(2/3-i)*6:e}function r(){function e(e){r.push(e),t()}function t(){if(a!==i.pending)for(;r.length>0;){var e=r.shift();a===i.resolved&&"function"==typeof e.done?e.done(n):a===i.rejected&&"function"==typeof e.fail&&e.fail(n),"function"==typeof e.always&&e.always(n)}}var i={pending:0,resolved:1,rejected:2},a=i.pending,n=null,r=[];return{state:function(){return a},value:function(){return n},changeState:function(e,r){return a===e?console.error("Cannot changeState to same state: "+e):a!==i.pending?console.error("Cannot changeState when promise is finalized."):(a=e,n=r,t(),a)},resolve:function(e){this.changeState(i.resolved,e)},reject:function(e){this.changeState(i.rejected,e)},always:function(t){return e({always:t}),this},done:function(t){return e({done:t}),this},fail:function(t){return e({fail:t}),this},isResolved:function(){return a===i.resolved},isRejected:function(){return a===i.rejected}}}e.prototype.createCanvas=function(e){var t=document.createElement("canvas");if("object"==typeof e)for(var i in e)t.style[i]=e[i];return this.container.appendChild(t),t},e.prototype.checkAsyncComplete=function(){var e=this,t=this.layers.length,i=0,a=0;if(t===this.layerCount){for(a=0;a<t;a++)this.layers[a].loaded&&i++;i===this.layerCount&&(e.loaded=!0,e.imgLoadPromise.resolve())}},e.prototype.setLayers=function(e){if("object"==typeof e&&e.length){var t=this;return this.initPromise.done(function(){var i=e.length,a="",n=[],r=t.dfltCanvasStyle;onImgLoad=function(){this.canvas.id=this.lbName,t.layers[this.lbIdx]={name:this.lbName,img:this,idx:this.lbIdx,canvas:this.canvas,ctx:this.ctx,loaded:!0,readOnly:this.lbReadOnly},t.layerHash[this.lbName]=this.lbIdx,t.checkAsyncComplete()},t.layers=[],t.layerCount=i;for(var o=0;o<i;o++)"object"!=typeof e[o]||"string"!=typeof e[o].name||e[o].name,e[o].img?"string"==typeof(a=e[o].img)?(n[o]=new Image,n[o].lbIdx=o,n[o].lbName=e[o].name.trim(),n[o].lbReadOnly=!!e[o].readOnly,t.layers[o]={name:n[o].lbName,loaded:!1},r.zIndex=n[o].lbIdx+1,n[o].canvas=t.createCanvas(r),n[o].ctx=n[o].canvas.getContext("2d"),n[o].onload=onImgLoad,n[o].src=a.trim()):console.error("Invalid image for layer "+e[o].name):console.error("Invalid layer: "+e[o].name);return t.imgLoadPromise}),t.imgLoadPromise.done(function(){t.drawImages()}),t.imgLoadPromise}},e.prototype.drawImages=function(){var e=this.layers.length,t=0,i=0,a=0,n=0,r=0,o=0,s=1,l=null,h=0;if(this.dimensions){for(h=0;h<e;h++)this.layers[h].img.width>a&&(a=this.layers[h].img.width),this.layers[h].img.height>n&&(n=this.layers[h].img.height);(s=(r=parseFloat(this.dimensions[0]/a))<(o=parseFloat(this.dimensions[1]/n))?r:o)>1&&(s=1)}for(h=0;h<e;h++)l=this.layers[h],t=Math.floor(l.img.width*s),i=Math.floor(l.img.height*s),l.canvas.width=t,l.canvas.height=i,l.img.origW=l.img.width,l.img.origH=l.img.height,l.img.width=t,l.img.height=i,l.ctx.drawImage(l.img,0,0,t,i),l.canvas.style.transition="opacity 1s linear",l.canvas.style.setProperty("-webkit-transition","opacity 1s linear"),l.canvas.style.opacity=1,l.imgData=l.ctx.getImageData(0,0,t,i)},e.prototype.setColor=function(e,i,a){if(e&&i&&this.layers.length){var n=this.getLayer(e),r=(t(i),null),o=n.ctx;if(n){if(a){if("string"!=typeof a||-1===this.imgOperations.indexOf(a.toLowerCase()))return void console.error("Invalid operation")}else a=this.dfltOperation;n.currentColor=i,a=a.toLowerCase(),(r=o.createImageData(n.img.width,n.img.height)).data.set(new Uint8ClampedArray(n.imgData.data)),this.colorImageData(n.canvas,r,i,a)}else console.error("Invalid layer: "+e)}else console.error("Unable to set colors. Invalid params or no layers present")},e.prototype.colorImageData=function(e,n,r,o){var s=n.data,l=e.getContext("2d"),h=l.createImageData(e.width,e.height),g=t(r),c={};o=o||this.dfltOperation,h.data.set(new Uint8ClampedArray(n.data)),origData=h.data;for(var d=0;d<s.length;d+=4)switch(c.r=origData[d+0],c.g=origData[d+1],c.b=origData[d+2],c.a=origData[d+3],o){case"multiply":s[d+0]=c.r/255*(g.r/255)*255,s[d+1]=c.g/255*(g.g/255)*255,s[d+2]=c.b/255*(g.b/255)*255,s[d+3]=c.a;break;case"screen":hsl=i(c.r,c.g,c.b),shiftHsl=i(g.r,g.g,g.b),newRgb=a(shiftHsl.h,shiftHsl.s,hsl.l),s[d+0]=newRgb.r,s[d+1]=newRgb.g,s[d+2]=newRgb.b,s[d+3]=c.a;break;case"grayscale":avg=(s[d]+s[d+1]+s[d+2])/3,s[d]=avg,s[d+1]=avg,s[d+2]=avg}l.putImageData(n,0,0)},e.prototype.resetLayer=function(e,t,i){var a=this.getLayer(e);a&&(t=isNaN(parseInt(t))?a.img.width:parseInt(t),i=isNaN(parseInt(i))?a.img.height:parseInt(i),a.ctx.clearRect(0,0,a.canvas.width,a.canvas.height),a.ctx.drawImage(a.img,0,0,t,i),a.currentColor="")},e.prototype.resetAllLayers=function(){for(var e=this.layers.length,t=0;t<e;t++)this.resetLayer(this.layers[t].name)},e.prototype.getOperations=function(){return this.imgOperations},e.prototype.getLayer=function(e){if("string"==typeof e&&e.trim()&&this.layers.length)return this.layers[this.layerHash[e]];console.error("Invalid layer name or no layers set")},e.prototype.getImage=function(e){var t=this.layers.length,i=null,a=null,n=null,r=null;style={display:"none"};{if(this.layers.length){e="string"==typeof e?e.trim():"image/png",r=this.getDimensions(),(i=this.createCanvas(style)).width=r.width,i.height=r.height,a=i.getContext("2d");for(var o=0;o<t;o++)n=this.layers[o],a.drawImage(n.canvas,0,0,n.img.width,n.img.height);return i.toDataURL(e)}console.error("Unable to save image: no layers present")}},e.prototype.getUnscaledImage=function(e){var t=this.layers.length,i=null,a=null,n=null,r=null,o=null,s=0,l=0,h=null,g={display:"none"};{if(this.layers.length){o=this.getOrigDimensions(),(i=this.createCanvas(g)).width=o.width,i.height=o.height;for(var c=0;c<t;c++)n=this.layers[c],(r=this.createCanvas(g)).width=n.img.origW,r.height=n.img.origH,a=r.getContext("2d"),s=n.img.width,l=n.img.height,n.img.width=n.img.origW,n.img.height=n.img.origH,a.drawImage(n.img,0,0,n.img.origW,n.img.origH),imgData=a.getImageData(0,0,n.img.origW,n.img.origH),n.img.width=s,n.img.height=l,n.currentColor&&this.colorImageData(r,imgData,n.currentColor),i.getContext("2d").drawImage(r,0,0),this.container.removeChild(r);return h=i.msToBlob?i.msToBlob():i.toDataURL(e),this.container.removeChild(i),h}console.error("Unable to save image: no layers present")}},e.prototype.getDimensions=function(){for(var e={width:0,height:0},t=0,i=this.layers.length;t<i;t++)layer=this.layers[t],layer.canvas.clientWidth>e.width&&(e.width=layer.canvas.clientWidth),layer.canvas.clientHeight>e.height&&(e.height=layer.canvas.clientHeight);return e},e.prototype.getOrigDimensions=function(){for(var e={width:0,height:0},t=0,i=this.layers.length;t<i;t++)layer=this.layers[t],layer.img.origW>e.width&&(e.width=layer.img.origW),layer.img.origH>e.height&&(e.height=layer.img.origH);return e},window.LayerBuilder=e}();