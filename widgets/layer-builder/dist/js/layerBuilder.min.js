!function(){function e(e,t){var i=this;if(e&&"string"==typeof e){if("object"!=typeof t&&(t={}),this.containerId=e,this.container=document.getElementById(e),this.name="string"==typeof t.name?t.name.trim():"",this.dimensions=null,t.hasOwnProperty("dimensions")&&"object"==typeof t.dimensions&&2===t.dimensions.length){var n=parseInt(t.dimensions[0]),a=parseInt(t.dimensions[1]);isNaN(n)||isNaN(a)||(this.dimensions=[n,a])}this.layers=[],this.layerHash={},this.layerCount=0,this.loaded=!1,this.imgLoadPromise=new s,this.initPromise=new s,this.imgOperations=["multiply","screen","grayscale"],this.dfltOperation="multiply",this.dfltCanvasStyle={position:"absolute",opacity:0},this.container?i.initPromise.resolve():document.addEventListener("DOMContentLoaded",function(){i.container=document.getElementById(i.containerId),i.initPromise.resolve()})}else console.error("Invalid containerId")}function t(e){var t=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,i=null;return e=e.replace(t,function(e,t,i,n){return t+t+i+i+n+n}),(i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e))?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null}function n(e,t,i){e/=255,t/=255,i/=255;var n,a,r=Math.max(e,t,i),s=Math.min(e,t,i),o=(r+s)/2;if(r==s)n=a=0;else{var l=r-s;switch(a=o>.5?l/(2-r-s):l/(r+s),r){case e:n=(t-i)/l+(t<i?6:0);break;case t:n=(i-e)/l+2;break;case i:n=(e-t)/l+4}n/=6}return{h:n,s:a,l:o}}function a(e,t,i){var n,a,s;if(0==t)n=a=s=i;else{var o=i<.5?i*(1+t):i+t-i*t,l=2*i-o;n=r(l,o,e+1/3),a=r(l,o,e),s=r(l,o,e-1/3)}return{r:Math.round(255*n),g:Math.round(255*a),b:Math.round(255*s)}}function r(e,t,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+(t-e)*(2/3-i)*6:e}function s(){function e(e){r.push(e),t()}function t(){if(n!==i.pending)for(;r.length>0;){var e=r.shift();n===i.resolved&&"function"==typeof e.done?e.done(a):n===i.rejected&&"function"==typeof e.fail&&e.fail(a),"function"==typeof e.always&&e.always(a)}}var i={pending:0,resolved:1,rejected:2},n=i.pending,a=null,r=[];return{state:function(){return n},value:function(){return a},changeState:function(e,r){return n===e?console.error("Cannot changeState to same state: "+e):n!==i.pending?console.error("Cannot changeState when promise is finalized."):(n=e,a=r,t(),n)},resolve:function(e){this.changeState(i.resolved,e)},reject:function(e){this.changeState(i.rejected,e)},always:function(t){return e({always:t}),this},done:function(t){return e({done:t}),this},fail:function(t){return e({fail:t}),this},isResolved:function(){return n===i.resolved},isRejected:function(){return n===i.rejected}}}e.prototype.createCanvas=function(e){var t=document.createElement("canvas");if("object"==typeof e)for(var i in e)t.style[i]=e[i];return this.container.appendChild(t),t},e.prototype.checkAsyncComplete=function(){var e=this,t=this.layers.length,i=0,n=0;if(t===this.layerCount){for(n=0;n<t;n++)this.layers[n].loaded&&i++;i===this.layerCount&&(e.loaded=!0,e.imgLoadPromise.resolve())}},e.prototype.setLayers=function(e){if("object"==typeof e&&e.length){var t=this;return this.initPromise.done(function(){var i=e.length,n="",a=[],r=t.dfltCanvasStyle;t.layers=[],t.layerCount=i;for(var s=0;s<i;s++)"object"!=typeof e[s]||"string"!=typeof e[s].name||e[s].name,e[s].img?"string"==typeof(n=e[s].img)?(a[s]=new Image,a[s].lbIdx=s,a[s].lbName=e[s].name.trim(),a[s].lbReadOnly=!!e[s].readOnly,t.layers[s]={name:a[s].lbName,loaded:!1},r.zIndex=a[s].lbIdx+1,a[s].canvas=t.createCanvas(r),a[s].ctx=a[s].canvas.getContext("2d"),a[s].onload=function(){this.canvas.setAttribute("data-layername",this.lbName),t.layers[this.lbIdx]={name:this.lbName,img:this,idx:this.lbIdx,canvas:this.canvas,ctx:this.ctx,loaded:!0,readOnly:this.lbReadOnly},t.layerHash[this.lbName]=this.lbIdx,t.checkAsyncComplete()},a[s].src=n.trim()):console.error("Invalid image for layer "+e[s].name):console.error("Invalid layer: "+e[s].name);return t.imgLoadPromise}),t.imgLoadPromise.done(function(){t.drawImages()}),t.imgLoadPromise}},e.prototype.drawImages=function(){var e=this.layers.length,t=0,i=0,n=0,a=0,r=0,s=0,o=1,l=null,h=0;if(this.dimensions){for(h=0;h<e;h++)this.layers[h].img.width>n&&(n=this.layers[h].img.width),this.layers[h].img.height>a&&(a=this.layers[h].img.height);(o=(r=parseFloat(this.dimensions[0]/n))<(s=parseFloat(this.dimensions[1]/a))?r:s)>1&&(o=1)}for(h=0;h<e;h++)l=this.layers[h],t=Math.floor(l.img.width*o),i=Math.floor(l.img.height*o),l.canvas.width=t,l.canvas.height=i,l.img.origW=l.img.width,l.img.origH=l.img.height,l.img.width=t,l.img.height=i,l.ctx.drawImage(l.img,0,0,t,i),l.canvas.style.transition="opacity 1s linear",l.canvas.style.setProperty("-webkit-transition","opacity 1s linear"),l.canvas.style.opacity=1;for(h=0;h<e;h++)this.layers[h].imgData=this.layers[h].ctx.getImageData(0,0,t,i)},e.prototype.setColor=function(e,t,i){if(e&&t&&this.layers.length){var n=this.getLayer(e),a=null,r=n.ctx;if(n){if(i){if("string"!=typeof i||-1===this.imgOperations.indexOf(i.toLowerCase()))return void console.error("Invalid operation");i=i.toLowerCase()}else i=this.dfltOperation;n.currentColor=t,(a=r.createImageData(n.img.width,n.img.height)).data.set(n.imgData.data),this.colorImageData(n.canvas,a,t,i)}else console.error("Invalid layer: "+e)}else console.error("Unable to set colors. Invalid params or no layers present")},e.prototype.colorImageData=function(e,r,s,o){var l=r.data,h=null,g=e.getContext("2d"),c=g.createImageData(e.width,e.height),d=t(s),m={},y=null,u=null,f=null,p=0;for(o=o||this.dfltOperation,c.data.set(r.data),h=c.data,i=0;i<l.length;i+=4)switch(m.r=h[i+0],m.g=h[i+1],m.b=h[i+2],m.a=h[i+3],o){case"multiply":l[i+0]=m.r/255*(d.r/255)*255,l[i+1]=m.g/255*(d.g/255)*255,l[i+2]=m.b/255*(d.b/255)*255,l[i+3]=m.a;break;case"screen":y=n(m.r,m.g,m.b),f=a((u=n(d.r,d.g,d.b)).h,u.s,y.l),l[i+0]=f.r,l[i+1]=f.g,l[i+2]=f.b,l[i+3]=m.a;break;case"grayscale":p=(l[i]+l[i+1]+l[i+2])/3,l[i]=p,l[i+1]=p,l[i+2]=p}g.putImageData(r,0,0)},e.prototype.resetLayer=function(e,t,i){var n=this.getLayer(e);n&&(t=isNaN(parseInt(t))?n.img.width:parseInt(t),i=isNaN(parseInt(i))?n.img.height:parseInt(i),n.ctx.clearRect(0,0,n.canvas.width,n.canvas.height),n.ctx.drawImage(n.img,0,0,t,i),n.currentColor="")},e.prototype.resetAllLayers=function(){for(var e=this.layers.length,t=0;t<e;t++)this.resetLayer(this.layers[t].name)},e.prototype.getOperations=function(){return this.imgOperations},e.prototype.getLayer=function(e){if("string"==typeof e&&e.trim()&&this.layers.length)return void 0!==this.layerHash[e]?this.layers[this.layerHash[e]]:null;console.error("Invalid layer name or no layers set")},e.prototype.getImage=function(e){var t="",i=this.layers.length,n=null,a=null,r=null,s=null,o={display:"none"};{if(this.layers.length){e="string"==typeof e?e.trim():"image/png",s=this.getDimensions(),(n=this.createCanvas(o)).width=s.width,n.height=s.height,a=n.getContext("2d");for(var l=0;l<i;l++)r=this.layers[l],a.drawImage(r.canvas,0,0,r.img.width,r.img.height);return t=n.toDataURL(e),this.container.removeChild(n),t}console.error("Unable to save image: no layers present")}},e.prototype.getUnscaledImage=function(e){var t=this.layers.length,i=null,n=null,a=null,r=null,s=null,o=0,l=0,h=null,g=null,c={display:"none"};{if(this.layers.length){s=this.getOrigDimensions(),(i=this.createCanvas(c)).width=s.width,i.height=s.height;for(var d=0;d<t;d++)a=this.layers[d],(r=this.createCanvas(c)).width=a.img.origW,r.height=a.img.origH,n=r.getContext("2d"),o=a.img.width,l=a.img.height,a.img.width=a.img.origW,a.img.height=a.img.origH,n.drawImage(a.img,0,0,a.img.origW,a.img.origH),g=n.getImageData(0,0,a.img.origW,a.img.origH),a.img.width=o,a.img.height=l,a.currentColor&&this.colorImageData(r,g,a.currentColor),i.getContext("2d").drawImage(r,0,0),this.container.removeChild(r);return h=i.msToBlob?i.msToBlob():i.toDataURL(e),this.container.removeChild(i),h}console.error("Unable to save image: no layers present")}},e.prototype.getDimensions=function(){for(var e={width:0,height:0},t=null,i=0,n=this.layers.length;i<n;i++)(t=this.layers[i]).canvas.clientWidth>e.width&&(e.width=t.canvas.clientWidth),t.canvas.clientHeight>e.height&&(e.height=t.canvas.clientHeight);return e},e.prototype.getOrigDimensions=function(){for(var e={width:0,height:0},t=null,i=0,n=this.layers.length;i<n;i++)(t=this.layers[i]).img.origW>e.width&&(e.width=t.img.origW),t.img.origH>e.height&&(e.height=t.img.origH);return e},window.LayerBuilder=e}();