!function(){function e(e,i){var a=this;if(e&&"string"==typeof e){if("object"!=typeof i&&(i={}),this.containerId=e,this.container=document.getElementById(e),this.name="string"==typeof i.name?i.name.trim():"",this.dimensions=null,i.hasOwnProperty("dimensions")&&"object"==typeof i.dimensions&&2===i.dimensions.length){var n=parseInt(i.dimensions[0]),r=parseInt(i.dimensions[1]);isNaN(n)||isNaN(r)||(this.dimensions=[n,r])}this.layers=[],this.layerHash={},this.layerCount=0,this.loaded=!1,this.imgLoadPromise=new t.promise,this.initPromise=new t.promise,this.imgOperations=["multiply","screen","grayscale"],this.dfltOperation="multiply",this.dfltCanvasStyle={position:"absolute",opacity:0},this.container?a.initPromise.resolve():document.addEventListener("DOMContentLoaded",function(){a.container=document.getElementById(a.containerId),a.initPromise.resolve()})}else console.error("Invalid containerId")}e.prototype.createCanvas=function(e){var t=document.createElement("canvas");if("object"==typeof e)for(var i in e)t.style[i]=e[i];return this.container.appendChild(t),t},e.prototype.checkAsyncComplete=function(){var e=this,t=this.layers.length,i=0,a=0;if(t===this.layerCount){for(a=0;a<t;a++)this.layers[a].loaded&&i++;i===this.layerCount&&(e.loaded=!0,e.imgLoadPromise.resolve())}},e.prototype.setLayers=function(e){if("object"==typeof e&&e.length){var t=this;return this.initPromise.done(function(){var i=e.length,a="",n=[],r=t.dfltCanvasStyle;t.layers=[],t.layerCount=i;for(var s=0;s<i;s++)"object"!=typeof e[s]||"string"!=typeof e[s].name||e[s].name,e[s].img?"string"==typeof(a=e[s].img)?(n[s]=new Image,n[s].lbIdx=s,n[s].lbName=e[s].name.trim(),n[s].lbReadOnly=!!e[s].readOnly,t.layers[s]={name:n[s].lbName,loaded:!1},r.zIndex=n[s].lbIdx+1,n[s].canvas=t.createCanvas(r),n[s].ctx=n[s].canvas.getContext("2d"),n[s].onload=function(){this.canvas.setAttribute("data-layername",this.lbName),t.layers[this.lbIdx]={name:this.lbName,img:this,idx:this.lbIdx,canvas:this.canvas,ctx:this.ctx,loaded:!0,readOnly:this.lbReadOnly},t.layerHash[this.lbName]=this.lbIdx,t.checkAsyncComplete()},n[s].src=a.trim()):console.error("Invalid image for layer "+e[s].name):console.error("Invalid layer: "+e[s].name);return t.imgLoadPromise}),t.imgLoadPromise.done(function(){t.drawImages()}),t.imgLoadPromise}},e.prototype.drawImages=function(){var e=this.layers.length,t=0,i=0,a=0,n=0,r=0,s=0,o=1,l=null,h=0;if(this.dimensions){for(h=0;h<e;h++)this.layers[h].img.width>a&&(a=this.layers[h].img.width),this.layers[h].img.height>n&&(n=this.layers[h].img.height);(o=(r=parseFloat(this.dimensions[0]/a))<(s=parseFloat(this.dimensions[1]/n))?r:s)>1&&(o=1)}for(h=0;h<e;h++)l=this.layers[h],t=Math.floor(l.img.width*o),i=Math.floor(l.img.height*o),l.canvas.width=t,l.canvas.height=i,l.img.origW=l.img.width,l.img.origH=l.img.height,l.img.width=t,l.img.height=i,l.ctx.drawImage(l.img,0,0,t,i),l.canvas.style.transition="opacity 1s linear",l.canvas.style.setProperty("-webkit-transition","opacity 1s linear"),l.canvas.style.opacity=1;for(h=0;h<e;h++)this.layers[h].imgData=this.layers[h].ctx.getImageData(0,0,t,i)},e.prototype.setColor=function(e,t,i){if(e&&t&&this.layers.length){var a=this.getLayer(e),n=null,r=a.ctx;if(a){if(i){if("string"!=typeof i||-1===this.imgOperations.indexOf(i.toLowerCase()))return void console.error("Invalid operation");i=i.toLowerCase()}else i=this.dfltOperation;a.currentColor=t,n=r.createImageData(a.img.width,a.img.height),this.copyImageData(n.data,a.imgData.data),this.colorImageData(a.canvas,n,t,i)}else console.error("Invalid layer: "+e)}else console.error("Unable to set colors. Invalid params or no layers present")},e.prototype.colorImageData=function(e,i,a,n){var r=i.data,s=null,o=e.getContext("2d"),l=o.createImageData(e.width,e.height),h=t.hexToRgb(a),g={},c=null,d=null,m=null,y=0;n=n||this.dfltOperation,this.copyImageData(l.data,i.data),s=l.data;for(var u=0;u<r.length;u+=4)switch(g.r=s[u+0],g.g=s[u+1],g.b=s[u+2],g.a=s[u+3],n){case"multiply":r[u+0]=g.r/255*(h.r/255)*255,r[u+1]=g.g/255*(h.g/255)*255,r[u+2]=g.b/255*(h.b/255)*255,r[u+3]=g.a;break;case"screen":c=t.rgbToHsl(g.r,g.g,g.b),d=t.rgbToHsl(h.r,h.g,h.b),m=t.hslToRgb(d.h,d.s,c.l),r[u+0]=m.r,r[u+1]=m.g,r[u+2]=m.b,r[u+3]=g.a;break;case"grayscale":y=(r[u]+r[u+1]+r[u+2])/3,r[u]=y,r[u+1]=y,r[u+2]=y}o.putImageData(i,0,0)},e.prototype.resetLayer=function(e,t,i){var a=this.getLayer(e);a&&(t=isNaN(parseInt(t))?a.img.width:parseInt(t),i=isNaN(parseInt(i))?a.img.height:parseInt(i),a.ctx.clearRect(0,0,a.canvas.width,a.canvas.height),a.ctx.drawImage(a.img,0,0,t,i),a.currentColor="")},e.prototype.resetAllLayers=function(){for(var e=this.layers.length,t=0;t<e;t++)this.resetLayer(this.layers[t].name)},e.prototype.getOperations=function(){return this.imgOperations},e.prototype.getLayer=function(e){if("string"==typeof e&&e.trim()&&this.layers.length)return void 0!==this.layerHash[e]?this.layers[this.layerHash[e]]:null;console.error("Invalid layer name or no layers set")},e.prototype.getImage=function(e){var t="",i=this.layers.length,a=null,n=null,r=null,s=null,o={display:"none"};{if(this.layers.length){e="string"==typeof e?e.trim():"image/png",s=this.getDimensions(),(a=this.createCanvas(o)).width=s.width,a.height=s.height,n=a.getContext("2d");for(var l=0;l<i;l++)r=this.layers[l],n.drawImage(r.canvas,0,0,r.img.width,r.img.height);return t=a.toDataURL(e),this.container.removeChild(a),t}console.error("Unable to save image: no layers present")}},e.prototype.getUnscaledImage=function(e){var t=this.layers.length,i=null,a=null,n=null,r=null,s=null,o=0,l=0,h=null,g=null,c={display:"none"};{if(this.layers.length){s=this.getOrigDimensions(),(i=this.createCanvas(c)).width=s.width,i.height=s.height;for(var d=0;d<t;d++)n=this.layers[d],(r=this.createCanvas(c)).width=n.img.origW,r.height=n.img.origH,a=r.getContext("2d"),o=n.img.width,l=n.img.height,n.img.width=n.img.origW,n.img.height=n.img.origH,a.drawImage(n.img,0,0,n.img.origW,n.img.origH),n.img.width=o,n.img.height=l,n.currentColor&&(g=a.getImageData(0,0,n.img.origW,n.img.origH),this.colorImageData(r,g,n.currentColor)),i.getContext("2d").drawImage(r,0,0),this.container.removeChild(r);return h=i.msToBlob?i.msToBlob():i.toDataURL(e),this.container.removeChild(i),h}console.error("Unable to save image: no layers present")}},e.prototype.getDimensions=function(){for(var e={width:0,height:0},t=null,i=0,a=this.layers.length;i<a;i++)(t=this.layers[i]).canvas.clientWidth>e.width&&(e.width=t.canvas.clientWidth),t.canvas.clientHeight>e.height&&(e.height=t.canvas.clientHeight);return e},e.prototype.getOrigDimensions=function(){for(var e={width:0,height:0},t=null,i=0,a=this.layers.length;i<a;i++)(t=this.layers[i]).img.origW>e.width&&(e.width=t.img.origW),t.img.origH>e.height&&(e.height=t.img.origH);return e},e.prototype.copyImageData=function(e,t){if("function"==typeof e.set)e.set(t);else for(var i=0,a=t.length;i<a;i++)e[i]=t[i]};var t={};t.hexToRgb=function(e){var t=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,i=null;return e=e.replace(t,function(e,t,i,a){return t+t+i+i+a+a}),(i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e))?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null},t.rgbToHsl=function(e,t,i){e/=255,t/=255,i/=255;var a,n,r=Math.max(e,t,i),s=Math.min(e,t,i),o=(r+s)/2;if(r==s)a=n=0;else{var l=r-s;switch(n=o>.5?l/(2-r-s):l/(r+s),r){case e:a=(t-i)/l+(t<i?6:0);break;case t:a=(i-e)/l+2;break;case i:a=(e-t)/l+4}a/=6}return{h:a,s:n,l:o}},t.hslToRgb=function(e,t,i){var a,n,r;if(0==t)a=n=r=i;else{var s=i<.5?i*(1+t):i+t-i*t,o=2*i-s;a=hue2rgb(o,s,e+1/3),n=hue2rgb(o,s,e),r=hue2rgb(o,s,e-1/3)}return{r:Math.round(255*a),g:Math.round(255*n),b:Math.round(255*r)}},t.hue2rgb=function(e,t,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+(t-e)*(2/3-i)*6:e},t.promise=function(){function e(e){r.push(e),t()}function t(){if(a!==i.pending)for(;r.length>0;){var e=r.shift();a===i.resolved&&"function"==typeof e.done?e.done(n):a===i.rejected&&"function"==typeof e.fail&&e.fail(n),"function"==typeof e.always&&e.always(n)}}var i={pending:0,resolved:1,rejected:2},a=i.pending,n=null,r=[];return{state:function(){return a},value:function(){return n},changeState:function(e,r){return a===e?console.error("Cannot changeState to same state: "+e):a!==i.pending?console.error("Cannot changeState when promise is finalized."):(a=e,n=r,t(),a)},resolve:function(e){this.changeState(i.resolved,e)},reject:function(e){this.changeState(i.rejected,e)},always:function(t){return e({always:t}),this},done:function(t){return e({done:t}),this},fail:function(t){return e({fail:t}),this},isResolved:function(){return a===i.resolved},isRejected:function(){return a===i.rejected}}},t.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},t.nonAlpha2Dash=function(e){return e.replace(/\W+/g,"-")},t.toggle=function(e,t){t&&(t.style.display="none",t.style.opacity=0),e&&(e.style.display="block",e.clientWidth,e.style.opacity=1)},t.hasClass=function(e,t){var i=new RegExp("(?:\\s|^)"+t+"(?:\\s|$)");return!!e.className.match(i)},t.addClass=function(e,t){-1===e.className.indexOf(t)&&(e.className+=" "+t,e.className=e.className.trim())},t.removeClass=function(e,t){var i=null,a=0;"object"!=typeof t&&(t=[t]),a=t.length;for(var n=0;n<a;n++)i=new RegExp("(?:\\s|^)"+t[n]+"(?:\\s|$)"),e.className=e.className.replace(i," ")},t.hide=function(e,t){e&&"object"==typeof e&&(t&&(e.style.opacity=0),e.style.display="none")},t.show=function(e,t,i){e&&"object"==typeof e&&(e.style.display=t||"block",i&&(e.style.opacity=1))},window.LBUtil=t,window.LayerBuilder=e}();